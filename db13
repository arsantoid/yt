#!/bin/bash

# ===================================================================
#           SETUP SCRIPT YTLIVE STREAMER FOR DEBIAN/UBUNTU
#           (v24 - USER PREFERENCE, FIX DEBIAN 13)
# ===================================================================

set -e # HENTIKAN SKRIP JIKA ADA ERROR

# --- Variabel Konfigurasi ---
PYTHON_SCRIPT_NAME="ytlive"
PYTHON_SCRIPT_PATH="/usr/local/bin/${PYTHON_SCRIPT_NAME}"
WORKER_SCRIPT_PATH="/usr/local/bin/ytlive-worker.sh"
CHANNELS_BASE_DIR="/root/data/channels"
SERVICE_USER="ytlive"
SERVICE_GROUP="ytlive"
FFMPEG_JV_DIR="/opt/ffmpeg-johnvansickle"

# --- Fungsi Logging ---
log_info() { echo -e "\e[32m[INFO]\e[0m $1"; }
log_warn() { echo -e "\e[33m[PERINGATAN]\e[0m $1"; }
log_error() { echo -e "\e[31m[ERROR]\e[0m $1"; exit 1; }

# --- 1. Konfigurasi Sistem ---
log_info "Mengatur zona waktu dan memperbarui paket..."
timedatectl set-timezone Asia/Jakarta || log_warn "Gagal mengatur zona waktu."
apt-get update -y >/dev/null || log_error "Gagal memperbarui daftar paket."

log_info "Menginstal dependensi dasar (termasuk psutil & requests dari APT)..."
apt-get install -y \
  python3 python3-pip \
  python3-psutil python3-requests \
  wget tar xz-utils acl logrotate || \
  log_error "Gagal menginstal dependensi."

# FIX PolicyKit: policykit-1 hilang di Debian 13, diganti polkitd+pkexec
log_info "Menginstal PolicyKit yang kompatibel (Debian 11â€“13)..."
if apt-get install -y policykit-1 2>/dev/null; then
    log_info "policykit-1 berhasil diinstal (mode Debian 11/legacy)."
else
    log_warn "policykit-1 tidak tersedia, menggunakan polkitd + pkexec (Debian 12/13+)."
    apt-get install -y polkitd pkexec || log_error "Gagal menginstal polkitd/pkexec."
fi

# --- 2. Pembaruan Komponen Skrip (Jadwal & Stream Aman) ---
log_info "Memperbarui komponen skrip (jadwal dan stream aktif akan tetap aman)..."
rm -f /etc/systemd/system/ytlive-stream@.service
rm -f /etc/systemd/system/ytlive-schedule-start@.service
rm -f /etc/systemd/system/ytlive-schedule-stop@.service
rm -f /etc/sudoers.d/ytlive
rm -f /etc/logrotate.d/ytlive
rm -f "${PYTHON_SCRIPT_PATH}"
rm -f "${WORKER_SCRIPT_PATH}"
log_info "Komponen lama berhasil dihapus, siap untuk diperbarui."

# --- 3. Instal FFMPEG (static JohnVansickle, sama seperti v24 asli) ---
if [ ! -f "/usr/bin/ffmpeg" ]; then
    log_info "FFMPEG tidak ditemukan, menginstal FFMPEG..."
    mkdir -p "${FFMPEG_JV_DIR}"
    cd /tmp
    wget -q --show-progress "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz"
    tar -xf ffmpeg-release-amd64-static.tar.xz -C "${FFMPEG_JV_DIR}" --strip-components=1
    ln -sf "${FFMPEG_JV_DIR}/ffmpeg" /usr/bin/ffmpeg
    ln -sf "${FFMPEG_JV_DIR}/ffprobe" /usr/bin/ffprobe
    log_info "FFMPEG berhasil diinstal."
else
    log_info "FFMPEG sudah ada, instalasi dilewati."
fi

# --- 4. Buat Direktori & Pengguna ---
log_info "Memeriksa direktori, pengguna, dan izin akses..."
mkdir -p "${CHANNELS_BASE_DIR}"
id -g "${SERVICE_GROUP}" &>/dev/null || groupadd "${SERVICE_GROUP}"
id -u "${SERVICE_USER}" &>/dev/null || useradd -r -s /bin/false -g "${SERVICE_GROUP}" "${SERVICE_USER}"
chown -R "${SERVICE_USER}:${SERVICE_GROUP}" "${CHANNELS_BASE_DIR}"
setfacl -m u:${SERVICE_USER}:x /root &>/dev/null || true
setfacl -m u:${SERVICE_USER}:x /root/data &>/dev/null || true
log_info "Direktori dan izin akses berhasil dikonfigurasi."

# --- 5. Buat Aturan Izin Sudo ---
log_info "Membuat aturan Sudo untuk izin service..."
echo 'ytlive ALL=(ALL) NOPASSWD: /bin/systemctl start ytlive-*, /bin/systemctl stop ytlive-*' | tee /etc/sudoers.d/ytlive
chmod 0440 /etc/sudoers.d/ytlive
log_info "Aturan Sudo berhasil dibuat."

# --- 6. Konfigurasi Log Rotation ---
log_info "Mengkonfigurasi rotasi log otomatis..."
cat << EOF > "/etc/logrotate.d/ytlive"
/root/data/channels/*/stream.log {
    daily
    rotate 7
    missingok
    notifempty
    compress
    delaycompress
    copytruncate
}
EOF
log_info "Logrotate untuk ytlive berhasil dikonfigurasi."

# --- 7. Buat Skrip Pekerja (Bash Worker) ---
log_info "Membuat skrip pekerja di ${WORKER_SCRIPT_PATH}..."
cat << EOF > "${WORKER_SCRIPT_PATH}"
#!/bin/bash
set -e
CHANNEL_NAME=\$1
# Jalankan (exec) FFMPEG. Perintah FFMPEG diambil dari output Python.
exec \$(/usr/bin/python3 ${PYTHON_SCRIPT_PATH} _internal_get_ffmpeg_cmd "\$CHANNEL_NAME") &>> stream.log
EOF
chmod +x "${WORKER_SCRIPT_PATH}"

# --- 8. Buat Template Service Systemd ---
log_info "Membuat template service Systemd..."
cat << EOF > "/etc/systemd/system/ytlive-stream@.service"
[Unit]
Description=YTLive Streamer for %i
[Service]
User=${SERVICE_USER}
Group=${SERVICE_GROUP}
WorkingDirectory=${CHANNELS_BASE_DIR}/%i
ExecStart=${WORKER_SCRIPT_PATH} %i
Restart=always
RestartSec=10
[Install]
WantedBy=multi-user.target
EOF
cat << EOF > "/etc/systemd/system/ytlive-schedule-start@.service"
[Unit]
Description=Scheduled start for YTLive Streamer channel %i
[Service]
Type=oneshot
User=${SERVICE_USER}
ExecStart=${PYTHON_SCRIPT_PATH} start %i
EOF
cat << EOF > "/etc/systemd/system/ytlive-schedule-stop@.service"
[Unit]
Description=Scheduled stop for YTLive Streamer channel %i
[Service]
Type=oneshot
User=${SERVICE_USER}
ExecStart=${PYTHON_SCRIPT_PATH} stop %i
EOF
systemctl daemon-reload

# --- 9. Tempatkan Skrip Manajemen (Python CLI) - PERSIS v24 ---
log_info "Menempatkan script manajemen Python ke ${PYTHON_SCRIPT_PATH}..."
cat << 'EOF' > "${PYTHON_SCRIPT_PATH}"
[MASUKKAN PERSIS BLOK PYTHON v24 ANDA DI SINI, TANPA PERUBAHAN SATU KARAKTER PUN]
EOF

chmod +x "${PYTHON_SCRIPT_PATH}" || { log_error "Gagal membuat skrip Python dapat dieksekusi."; exit 1; }
log_info "Skrip Python berhasil ditempatkan."

log_info "==================================================="
log_info "        YTLIVE STREAMER SETUP COMPLETE (v24-FIX)"
log_info "==================================================="
log_info "Logika FFMPEG & HELP tetap 100% sama seperti script produksi."
log_info "Jalankan 'ytlive' untuk melihat perintah."
